<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DENTLEEN | Ø¯Ù†Øª Ù„ÙŠÙ† - Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø³Ù†Ø§Ù† ÙˆØªØ¬Ù‡ÙŠØ² Ø¹ÙŠØ§Ø¯Ø§Øª ÙÙŠ Ù…ØµØ±</title>
    
    <!-- SEO -->
    <meta name="description" content="Ø¯Ù†Øª Ù„ÙŠÙ† (Dentleen) - Ø§Ù„Ù…ØªØ¬Ø± Ø§Ù„Ø£ÙˆÙ„ Ù„Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø·Ø¨ Ø§Ù„Ø£Ø³Ù†Ø§Ù† ÙÙŠ Ù…ØµØ±. ØªØ³ÙˆÙ‚ Ø£ÙˆÙ†Ù„Ø§ÙŠÙ†: Ø­Ø´Ùˆ ÙƒÙˆÙ…Ø¨ÙˆØ²ÙŠØªØŒ Caries DetectorØŒ Ø£Ø¯ÙˆØ§Øª Endo.">
    <meta name="keywords" content="Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø£Ø³Ù†Ø§Ù†, Dentleen, Caries Detector Dye Gel, Ø­Ø´Ùˆ Ø¹ØµØ¨, Ø£Ø¯ÙˆØ§Øª Ø£Ø³Ù†Ø§Ù† Ù…ØµØ±, D-Seal">
    <meta name="author" content="Dentleen">
    
    <!-- Scripts & Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <!-- SEO Schema -->
    <script id="json-ld-products" type="application/ld+json"></script>

    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Tajawal', sans-serif; background-color: #1f1f1f; color: #e0e0e0; overflow-x: hidden; }
        
        .product-card { background-color: #2a2a2a; border: 1px solid #374151; transition: all 0.3s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(45, 212, 191, 0.2); border-color: #2dd4bf; }
        
        .full-page-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100vh;
            background-color: #1f1f1f; z-index: 2000; overflow-y: auto;
            transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .full-page-view.active { transform: translateX(0); }

        .points-badge {
            background: linear-gradient(135deg, #fbbf24 0%, #d97706 100%);
            color: #1a202c; font-weight: bold; padding: 4px 12px; border-radius: 9999px;
            display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 10px rgba(251, 191, 36, 0.3);
        }

        .cart-badge {
            position: absolute; top: -5px; right: -5px; background-color: #ef4444; color: white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 12px; display: flex;
            align-items: center; justify-content: center; font-weight: bold;
        }

        .admin-table th, .admin-table td { padding: 12px; text-align: right; border-bottom: 1px solid #4b5563; }
        .admin-table th { background-color: #374151; color: #2dd4bf; }
        .admin-table tr:hover { background-color: #374151; }

        /* Animation Classes */
        .reveal-on-scroll { opacity: 0; transform: translateY(30px); transition: all 0.8s ease-out; }
        .reveal-on-scroll.is-visible { opacity: 1; transform: translateY(0); }

        /* Loading Overlay */
        #loading-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; 
            display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px);
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #2dd4bf; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f1f1f; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2dd4bf; }
    </style>
</head>
<body class="text-gray-200">

    <!-- Loading Screen -->
    <div id="loading-overlay" style="display: none;">
        <div class="text-center">
            <div class="spinner mb-4 mx-auto"></div>
            <p class="text-teal-400 font-bold">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...</p>
            <button onclick="window.showLoading(false)" class="mt-4 text-sm text-gray-400 underline hover:text-white">Ø¥Ù„ØºØ§Ø¡</button>
        </div>
    </div>

    <!-- Header -->
    <header class="bg-gray-900/95 backdrop-blur-md shadow-lg p-4 sticky top-0 z-50 border-b border-gray-700">
        <div class="container mx-auto flex justify-between items-center">
            
            <div class="flex items-center gap-4">
                <img src="logo.png" alt="Dentleen" class="h-10 w-auto cursor-pointer hover:opacity-80 transition" onclick="window.showMainView()">
                <div id="user-status-area" class="hidden md:flex items-center gap-3"></div>
            </div>

            <nav class="hidden md:flex items-center gap-6 font-medium">
                <a href="#products" onclick="window.showMainView()" class="hover:text-teal-400 transition">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
                <a href="#offers" onclick="window.showMainView()" class="hover:text-red-400 transition">Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
                <a href="#contact" onclick="window.showMainView()" class="hover:text-teal-400 transition">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</a>
                <button id="admin-link-btn" onclick="window.showAdminDashboard()" class="hidden text-yellow-500 font-bold hover:text-yellow-400 transition"><i class="fas fa-cogs"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
            </nav>

            <div class="flex items-center gap-4">
                <button onclick="window.scrollToCart()" class="relative text-gray-300 hover:text-white transition text-2xl mx-2">
                    <i class="fas fa-shopping-cart"></i>
                    <span id="header-cart-count" class="cart-badge hidden">0</span>
                </button>

                <!-- Desktop Auth Area -->
                <div class="hidden md:flex items-center gap-2" id="desktop-auth-wrapper">
                    <button id="auth-btn" onclick="window.toggleAuthModal()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                        <i class="fas fa-user-circle ml-2"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                </div>

                <button class="md:hidden text-gray-300 text-2xl" id="mobile-menu-btn"><i class="fas fa-bars"></i></button>
            </div>
        </div>
        
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden bg-gray-800 p-4 absolute w-full left-0 border-t border-gray-700 text-center space-y-4 shadow-xl z-40">
             <div id="mobile-user-status" class="flex justify-center mb-2"></div>
             <button id="mobile-admin-btn" onclick="window.showAdminDashboard()" class="hidden w-full text-yellow-500 font-bold py-2 border border-yellow-500 rounded-lg">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
             <button id="mobile-login-btn" onclick="window.toggleAuthModal()" class="w-full bg-teal-600 text-white py-2 rounded-lg font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
             <button id="mobile-logout-btn" onclick="window.logout()" class="hidden w-full bg-red-600 text-white py-2 rounded-lg font-bold">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
             
             <a href="#products" onclick="window.showMainView();window.toggleMobileMenu()" class="block py-2 text-teal-400 border-b border-gray-700">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
             <a href="#offers" onclick="window.showMainView();window.toggleMobileMenu()" class="block py-2 text-red-400 border-b border-gray-700">Ø§Ù„Ø¹Ø±ÙˆØ¶</a>
             <a href="#contact" onclick="window.showMainView();window.toggleMobileMenu()" class="block py-2">Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</a>
        </div>
    </header>

    <!-- ADMIN DASHBOARD -->
    <div id="admin-view" class="hidden min-h-screen bg-gray-900 p-6">
        <div class="container mx-auto max-w-6xl">
            <div class="flex justify-between items-center mb-8 bg-gray-800 p-6 rounded-2xl shadow-lg border border-gray-700">
                <div>
                    <h1 class="text-3xl font-bold text-yellow-500"><i class="fas fa-user-shield ml-3"></i> Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                    <p class="text-gray-400 mt-2">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ÙˆØ§Ù„Ù†Ù‚Ø§Ø·</p>
                </div>
                <button onclick="window.showMainView()" class="bg-gray-700 hover:bg-gray-600 text-white px-6 py-2 rounded-lg font-bold">Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
            </div>

            <!-- Search Bar -->
            <div class="mb-6 relative">
                <input type="text" id="admin-search" onkeyup="window.searchUsers()" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." class="w-full bg-gray-800 border border-gray-700 text-white rounded-xl px-5 py-3 pl-10 focus:border-teal-500 outline-none shadow-md">
                <i class="fas fa-search absolute left-4 top-4 text-gray-500"></i>
            </div>

            <div class="bg-gray-800 rounded-2xl shadow-xl overflow-hidden border border-gray-700">
                <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-white">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h2>
                    <span class="bg-teal-900 text-teal-300 px-3 py-1 rounded-full text-sm" id="total-users-count">--</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full admin-table text-sm md:text-base">
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th>
                                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                                <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody id="admin-users-list"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN VIEW -->
    <div id="main-view" class="transition-opacity duration-300">
        
        <!-- Hero -->
        <section class="relative bg-gray-800 py-16 md:py-24 overflow-hidden">
            <div class="absolute inset-0 opacity-10 pointer-events-none">
                <i class="fas fa-tooth absolute top-10 left-10 text-9xl text-teal-500"></i>
            </div>
            <div class="container mx-auto px-4 flex flex-col md:flex-row items-center gap-10 relative z-10">
                <div class="md:w-1/2 text-center md:text-right">
                    <h1 class="text-4xl md:text-6xl font-extrabold mb-6 leading-tight">
                        Ø´Ø±ÙŠÙƒÙƒ Ø§Ù„Ù…ÙˆØ«ÙˆÙ‚ <br> <span class="text-teal-400">Ù„ØªØ¬Ù‡ÙŠØ² Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø£Ø³Ù†Ø§Ù†</span>
                    </h1>
                    <!-- Promo Text: Hidden when logged in -->
                    <p id="hero-promo-text" class="text-lg text-gray-400 mb-8 transition-opacity duration-500">
                        Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ùƒ Ø§Ù„Ø¢Ù† ÙˆØ§Ø¬Ù…Ø¹ Ø§Ù„Ù†Ù‚Ø§Ø· Ù…Ø¹ ÙƒÙ„ Ø·Ù„Ø¨! <br>
                        <span class="text-yellow-500 font-bold">Ù†Ù‚Ø§Ø· ÙˆÙ„Ø§Ø¡ Ø­Ù‚ÙŠÙ‚ÙŠØ© Ù„ÙƒÙ„ 1 Ø¬Ù†ÙŠÙ‡</span>
                    </p>
                    <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                        <a href="#products" class="bg-teal-500 hover:bg-teal-600 text-white px-8 py-3 rounded-full font-bold shadow-lg transition transform hover:scale-105">ØªØµÙØ­ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</a>
                    </div>
                </div>
                <div class="md:w-1/2">
                    <img src="logo.png" alt="Dentleen" class="w-full max-w-md mx-auto drop-shadow-2xl animate-float">
                </div>
            </div>
        </section>

        <!-- Products -->
        <section id="products" class="py-16 container mx-auto px-4">
            <h2 class="text-3xl font-bold text-teal-400 mb-8 border-b border-gray-700 pb-4">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
            <div id="products-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8"></div>
        </section>

        <!-- Offers -->
        <section id="offers" class="py-16 bg-gray-800/50">
            <div class="container mx-auto px-4">
                <h2 class="text-3xl font-bold text-red-500 text-center mb-12">Ø§Ù„Ø¹Ø±ÙˆØ¶ ÙˆØ§Ù„Ø¨Ø§ÙƒØ¯Ø¬Ø§Øª</h2>
                <div id="offers-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
            </div>
        </section>

        <!-- Cart -->
        <section id="contact" class="py-16 bg-gray-800 border-t border-gray-700">
            <div class="container mx-auto px-4 max-w-4xl">
                <div class="bg-gray-900 rounded-2xl shadow-2xl p-8 border border-gray-600 relative">
                    <div class="flex items-center justify-between mb-6 border-b border-gray-700 pb-4">
                        <h2 class="text-3xl font-bold text-teal-400"><i class="fas fa-shopping-cart ml-2"></i>Ø§Ù„Ø³Ù„Ø©</h2>
                        <div id="auth-inline-container"></div>
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm text-gray-400 mb-2">Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬ Ù„Ù„Ø³Ù„Ø© Ø³Ø±ÙŠØ¹Ø§Ù‹:</label>
                        <div class="flex gap-2">
                            <select id="quick-product-select" class="flex-1 bg-gray-800 text-white border border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:border-teal-500">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬...</option>
                            </select>
                            <button onclick="window.addFromDropdown()" class="bg-teal-600 hover:bg-teal-700 text-white px-4 py-2 rounded-lg font-bold">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <div id="loyalty-section" class="hidden mb-6 bg-gradient-to-r from-gray-800 to-gray-700 p-4 rounded-xl border border-yellow-500/30">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-coins text-yellow-400 text-2xl"></i>
                                <div>
                                    <h4 class="font-bold text-yellow-400">Ø±ØµÙŠØ¯Ùƒ: <span id="user-points-display">0</span> Ù†Ù‚Ø·Ø©</h4>
                                    <p class="text-xs text-gray-400">ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ù†Ù‚Ø§Ø· Ø¨Ø®ØµÙ…</p>
                                </div>
                            </div>
                            <button id="redeem-btn" onclick="window.handleRedeemPoints()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded-lg text-sm font-bold transition">
                                Ø®ØµÙ… 25 Ø¬Ù†ÙŠÙ‡
                            </button>
                        </div>
                        <div id="redeem-msg" class="text-sm mt-2 text-green-400 hidden font-bold text-center bg-green-900/20 p-2 rounded"></div>
                    </div>

                    <div id="cart-items" class="space-y-4 mb-6 min-h-[100px] max-h-[400px] overflow-y-auto pr-2 custom-scrollbar">
                        <p class="text-center text-gray-500 py-8">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>
                    </div>

                    <div class="space-y-2 text-lg border-t border-gray-700 pt-4">
                        <div class="flex justify-between text-gray-400"><span>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙØ±Ø¹ÙŠ:</span><span id="cart-subtotal">0 Ø¬.Ù…</span></div>
                        <div id="discount-row" class="flex justify-between text-green-400 hidden"><span>Ø®ØµÙ… Ø§Ù„Ù†Ù‚Ø§Ø·:</span><span>- <span id="cart-discount">0</span> Ø¬.Ù…</span></div>
                        <div class="flex justify-between text-3xl font-bold text-teal-400 mt-2 items-center">
                            <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                            <span id="cart-total" class="flex gap-2 items-center">
                                0 Ø¬.Ù…
                            </span>
                        </div>
                    </div>
                    
                    <div class="bg-blue-900/30 p-3 rounded-lg mt-4 mb-8 text-center border border-blue-900/50">
                        <p class="text-blue-200 text-sm">Ù†Ù‚Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø³ØªØ­Ù‚Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨: <span id="potential-points" class="font-bold text-white text-lg">0</span> (ØªØ¶Ø§Ù ÙŠØ¯ÙˆÙŠØ§Ù‹)</p>
                    </div>

                    <!-- Shipping Info Section -->
                    <div id="shipping-info" class="space-y-3 bg-gray-700/50 p-4 rounded-xl border border-gray-600 mb-4 mt-4">
                        <p class="text-sm text-yellow-300 font-bold mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ (ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§):</p>
                        <input type="text" id="checkout-name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„ÙƒØ§Ù…Ù„" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:border-teal-500 outline-none">
                        <input type="tel" id="checkout-phone" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (11 Ø±Ù‚Ù…)" maxlength="11" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:border-teal-500 outline-none">
                        <input type="text" id="checkout-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„ (Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© - Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© - Ø§Ù„Ø´Ø§Ø±Ø¹)" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-white focus:border-teal-500 outline-none">
                    </div>

                    <button id="init-checkout-btn" onclick="window.initiateCheckout()" class="w-full bg-green-600 hover:bg-green-700 text-white py-4 rounded-xl font-bold text-xl shadow-lg transition mt-6">
                        Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø·Ù„Ø¨
                    </button>
                </div>
            </div>
        </section>

        <footer class="bg-black py-8 text-center text-gray-500 text-sm"><p>&copy; 2024 Dentleen</p></footer>
    </div>

    <!-- Product View Modal -->
    <div id="product-full-view" class="full-page-view p-4 md:p-12 overflow-y-auto">
        <button onclick="window.showMainView()" class="fixed top-6 left-6 z-50 bg-gray-800/80 backdrop-blur text-white p-3 rounded-full hover:bg-gray-700 transition shadow-lg">
            <i class="fas fa-arrow-right text-xl"></i>
        </button>
        <div class="container mx-auto max-w-5xl mt-16 md:mt-12 mb-12">
            <div class="grid md:grid-cols-2 gap-8 items-start">
                <div class="space-y-6">
                    <div class="bg-gray-800 rounded-3xl p-6 flex items-center justify-center shadow-2xl min-h-[300px]">
                        <img id="fp-image" src="" class="w-full max-h-[400px] object-contain">
                    </div>
                </div>
                <div class="bg-gray-800/50 p-6 rounded-3xl border border-gray-700">
                    <h1 id="fp-title" class="text-3xl font-bold text-white mb-4"></h1>
                    <p id="fp-price" class="text-3xl text-teal-400 font-bold mb-6"></p>
                    <div id="fp-desc" class="text-gray-300 mb-8 leading-relaxed"></div>
                    <div class="flex items-center gap-4 bg-gray-700 p-2 rounded-xl mb-4">
                        <span class="text-gray-400 mr-2">Ø§Ù„ÙƒÙ…ÙŠØ©:</span>
                        <button onclick="window.updateFpQuantity(1)" class="w-8 h-8 bg-gray-600 rounded">+</button>
                        <input id="fp-quantity" type="number" value="1" min="1" class="w-12 bg-transparent text-center font-bold" readonly>
                        <button onclick="window.updateFpQuantity(-1)" class="w-8 h-8 bg-gray-600 rounded">-</button>
                    </div>
                    <button onclick="window.addToCartFromPage()" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-xl shadow-lg">Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal-overlay fixed inset-0 z-[3000] hidden flex items-center justify-center bg-black/80 backdrop-blur-sm px-4">
        <div class="bg-gray-800 border border-gray-700 p-8 rounded-2xl max-w-md w-full relative">
            <button onclick="window.toggleAuthModal()" class="absolute top-4 left-4 text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-2xl font-bold text-white text-center mb-6">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
            <form id="auth-form" class="space-y-4">
                <input type="text" id="auth-name" placeholder="Ø§Ù„Ø§Ø³Ù…" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                <input type="tel" id="auth-phone" placeholder="Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ (11 Ø±Ù‚Ù…)" maxlength="11" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                <input type="text" id="auth-address" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø¨Ø§Ù„ØªÙØµÙŠÙ„" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white">
                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg">Ø¯Ø®ÙˆÙ„</button>
            </form>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="modal-overlay fixed inset-0 z-[4000] hidden flex items-center justify-center bg-black/90 backdrop-blur-sm px-4">
        <div class="bg-gradient-to-br from-gray-900 to-gray-800 border-2 border-teal-600 p-8 rounded-3xl max-w-md w-full relative shadow-2xl transform scale-100 transition-all">
            <button onclick="window.closeConfirmModal()" class="absolute top-4 left-4 text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
            <div class="text-center mb-6">
                <div class="bg-teal-900/30 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border border-teal-500">
                    <i class="fas fa-check text-3xl text-teal-400"></i>
                </div>
                <h2 class="text-2xl font-bold text-white mb-2">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨</h2>
                <p class="text-gray-400 text-sm">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø±Ø³Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø·Ù„Ø¨ØŸ</p>
            </div>
            <div class="bg-gray-800/50 rounded-xl p-4 mb-6 border border-gray-700 max-h-40 overflow-y-auto custom-scrollbar" id="confirm-items-list"></div>
            <div class="flex justify-between items-center mb-6 bg-gray-800 p-3 rounded-lg">
                <span class="text-gray-400">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:</span>
                <span id="confirm-total-price" class="text-xl font-bold text-teal-400">0 Ø¬.Ù…</span>
            </div>
            <div class="flex gap-3">
                <button onclick="window.closeConfirmModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 rounded-xl transition">ØªØ±Ø§Ø¬Ø¹</button>
                <button onclick="window.confirmOrder()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fab fa-whatsapp text-xl"></i> ØªØ£ÙƒÙŠØ¯ ÙˆØ¥Ø±Ø³Ø§Ù„
                </button>
            </div>
        </div>
    </div>

    <button id="scrollToTopBtn" class="fixed bottom-6 right-6 bg-teal-600 text-white p-3 rounded-full shadow-lg opacity-0 pointer-events-none transition-all z-40"><i class="fas fa-arrow-up"></i></button>

    <!-- App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, setDoc, updateDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBSjKp5WDnHSeYrsMSCKIAKT0oiYOfS7O0",
            authDomain: "planning-with-ai-97e1d.firebaseapp.com",
            databaseURL: "https://planning-with-ai-97e1d-default-rtdb.firebaseio.com",
            projectId: "planning-with-ai-97e1d",
            storageBucket: "planning-with-ai-97e1d.firebasestorage.app",
            messagingSenderId: "235003282777",
            appId: "1:235003282777:web:3e9d9273dc93618f5d7848"
        };

        // Init Firebase Safely
        let db = null;
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            const auth = getAuth(app);
            signInAnonymously(auth).catch(console.error);
        } catch(e) { console.error("Firebase init failed:", e); }

        const USERS_COLLECTION = `artifacts/dentleen-app-main/public/data/users`;
        const WHATSAPP_NUMBER = "201508259538"; 
        const ADMIN_PHONE = "01010681114";
        const PRODUCTS_DATA = [
            { id: 'p3', name: 'Caries Detector Dye Gel', price: 160, img: 'cdd2.jpg', desc: 'Ø¬Ù„ ÙƒØ§Ø´Ù Ù„Ù„ØªØ³ÙˆØ³ (3 Ø¬Ù…).', type: 'product' },
            { id: 'p1', name: 'SDF 1ml', price: 400, img: 'sdf.png', desc: 'Silver Diamine Fluoride 1ml.', type: 'product' },
            { id: 'p2', name: 'SDF 4ml', price: 1190, img: 'sdf.png', desc: 'SDF 4ml Value Pack.', type: 'product' },
            { id: 'p4', name: 'Caries Detector Dye Liquid', price: 225, img: 'cdd.jpg', desc: 'Ø³Ø§Ø¦Ù„ ÙƒØ§Ø´Ù Ù„Ù„ØªØ³ÙˆØ³ 4 Ù…Ù„.', type: 'product' },
            { id: 'p5', name: 'MTA 0.25 gm', price: 50, img: 'mta.jpg', desc: 'MTA 0.25g.', type: 'product' },
            { id: 'p7', name: 'D-Seal 12 gm', price: 395, img: 'd-seal12.png', desc: 'D-Seal Resin Sealer Automix.', type: 'product' },
            { id: 'p8', name: 'D-Seal 8 gm', price: 300, img: 'd-seal 8.PNG', desc: 'D-Seal Manual Mix.', type: 'product' },
            { id: 'p9', name: 'D-Seal 20 gm', price: 495, img: 'D-Seal20.JPG', desc: 'D-Seal Economy Pack.', type: 'product' },
            { id: 'p10', name: 'Edta 5 gm', price: 170, img: 'edta.png', desc: 'EDTA Gel 5g.', type: 'product' },
            { id: 'p11', name: 'Etch 5 gm', price: 50, img: 'etch.jpg', desc: 'Etch 37%.', type: 'product' },
            { id: 'p12', name: 'Porcelain Acid Etch', price: 170, img: 'porclean.png', desc: 'Hydrofluoric Acid.', type: 'product' },
            { id: 'p13', name: 'HEMOSTATIC LIQUID', price: 135, img: 'beld-of.png', desc: 'Ø³Ø§Ø¦Ù„ ÙˆÙ‚Ù Ø§Ù„Ù†Ø²ÙŠÙ.', type: 'product' },
            { id: 'p14', name: 'ROOT HEAL', price: 110, img: 'root heal.png', desc: 'Intracanal Medicament.', type: 'product' },
            { id: 'p15', name: 'HOLDENT 20 gm', price: 155, img: 'hole.PNG', desc: 'ÙƒØ±ÙŠÙ… ØªØ«Ø¨ÙŠØª Ø£Ø·Ù‚Ù….', type: 'product' },
            { id: 'o1', name: 'Ø¨Ø§ÙƒØ¯Ø¬ Ø§Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø´Ø§Ù…Ù„', price: 260, img: 'bakedg.png', desc: 'Etch, Edta, MTA, Resin Sealer, Caries Detector.', type: 'offer' },
            { id: 'o2', name: 'Offer 1: Endo Basic', price: 370, img: 'file.png', desc: 'D-seal 8g + File Mani #10.', type: 'offer' },
            { id: 'o3', name: 'Offer 2: Fiber Post Kit', price: 320, img: 'ever x .png', desc: 'Caries dye + Ever X.', type: 'offer' },
            { id: 'o4', name: 'Offer 3: Bonding Master', price: 620, img: 'bond.png', desc: 'Caries dye + Etch + Bond Bisco.', type: 'offer' },
            { id: 'o5', name: 'Offer 4: Tokuyama Special', price: 1300, img: 'tok.png', desc: 'D-seal 20g + Syringe Tokuyama.', type: 'offer' },
            { id: 'o6', name: 'Offer 5: Gutta Percha Deal', price: 550, img: 'guta.png', desc: 'D-seal 20g + Gutta Percha.', type: 'offer' },
            { id: 'o7', name: 'Offer 6: Ever X + Sealer', price: 400, img: 'Ever x capsule.png', desc: 'Ever X + D-seal 8g.', type: 'offer' }
        ];

        let cart = JSON.parse(localStorage.getItem('dentleen_cart')) || [];
        let currentUser = null;
        let isRedeeming = false; 
        let currentViewingProduct = null;
        let adminUnsubscribe = null;
        let allUsersData = [];

        // Helpers Expose
        window.showMainView = () => {
            document.getElementById('product-full-view').classList.remove('active');
            document.getElementById('admin-view').classList.add('hidden');
            document.getElementById('main-view').classList.remove('hidden');
            if(adminUnsubscribe) { adminUnsubscribe(); adminUnsubscribe = null; }
        };
        
        window.openProductPage = (id) => {
            const product = PRODUCTS_DATA.find(p => p.id === id);
            if (!product) return;
            currentViewingProduct = product;
            document.getElementById('fp-title').textContent = product.name;
            document.getElementById('fp-price').textContent = `${product.price} Ø¬.Ù…`;
            document.getElementById('fp-image').src = product.img;
            document.getElementById('fp-desc').textContent = product.desc;
            document.getElementById('fp-quantity').value = 1;
            document.getElementById('product-full-view').classList.add('active');
        };

        window.toggleMobileMenu = () => document.getElementById('mobile-menu').classList.toggle('hidden');
        window.toggleAuthModal = () => document.getElementById('auth-modal').classList.toggle('hidden');
        window.updateFpQuantity = (n) => { const el = document.getElementById('fp-quantity'); let v = parseInt(el.value)+n; if(v<1)v=1; el.value=v; };
        window.scrollToCart = () => { window.showMainView(); document.getElementById('contact').scrollIntoView(); };
        
        window.showLoading = (show) => {
            const el = document.getElementById('loading-overlay');
            if(show) { el.style.display = 'flex'; setTimeout(() => el.style.display = 'none', 10000); }
            else el.style.display = 'none';
        };

        window.quickAdd = (id) => {
            const p = PRODUCTS_DATA.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.quantity++; else cart.push({...p, quantity: 1});
            localStorage.setItem('dentleen_cart', JSON.stringify(cart));
            updateCartUI();
            window.scrollToCart();
        };

        window.addToCartFromPage = () => {
            const qty = parseInt(document.getElementById('fp-quantity').value);
            const id = currentViewingProduct.id;
            const p = PRODUCTS_DATA.find(x => x.id === id);
            const exist = cart.find(x => x.id === id);
            if(exist) exist.quantity += qty; else cart.push({...p, quantity: qty});
            localStorage.setItem('dentleen_cart', JSON.stringify(cart));
            updateCartUI();
            window.showMainView();
            document.getElementById('contact').scrollIntoView();
        };

        window.removeFromCart = (id) => {
            cart = cart.filter(x => x.id !== id);
            localStorage.setItem('dentleen_cart', JSON.stringify(cart));
            updateCartUI();
        };

        window.updateCartQuantity = (id, n) => {
            const item = cart.find(x => x.id === id);
            if(item) {
                item.quantity += n;
                if(item.quantity <= 0) cart = cart.filter(x => x.id !== id);
                localStorage.setItem('dentleen_cart', JSON.stringify(cart));
                updateCartUI();
            }
        };

        function updateCartUI() {
            const container = document.getElementById('cart-items');
            container.innerHTML = '';
            let subtotal = 0, count = 0;
            
            if(cart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</p>';
                isRedeeming = false; 
            } else {
                cart.forEach(item => {
                    subtotal += item.price * item.quantity;
                    count += item.quantity;
                    container.innerHTML += `
                        <div class="flex justify-between items-center bg-gray-700/30 p-2 rounded mb-2">
                            <div class="text-sm font-bold text-white">${item.name} <span class="text-teal-400">(${item.price})</span></div>
                            <div class="flex items-center gap-2">
                                <button onclick="window.updateCartQuantity('${item.id}', -1)" class="px-2 bg-gray-600 rounded">-</button>
                                <span>${item.quantity}</span>
                                <button onclick="window.updateCartQuantity('${item.id}', 1)" class="px-2 bg-gray-600 rounded">+</button>
                                <button onclick="window.removeFromCart('${item.id}')" class="text-red-400"><i class="fas fa-trash"></i></button>
                            </div>
                        </div>`;
                });
            }
            
            const badge = document.getElementById('header-cart-count');
            if(count>0) { badge.textContent = count; badge.classList.remove('hidden'); } else badge.classList.add('hidden');
            
            document.getElementById('cart-subtotal').textContent = subtotal + ' Ø¬.Ù…';
            
            const totalEl = document.getElementById('cart-total');
            const discountRow = document.getElementById('discount-row');
            const cartDiscountEl = document.getElementById('cart-discount');
            const redeemBtn = document.getElementById('redeem-btn');
            const redeemMsg = document.getElementById('redeem-msg');

            let discount = 0;
            if (isRedeeming && currentUser && currentUser.points >= 50 && subtotal > 0) {
                // UPDATE: 50 points = 25 EGP
                const maxDiscountFromPoints = Math.floor(currentUser.points / 50) * 25;
                discount = Math.min(maxDiscountFromPoints, subtotal);
            }

            const earnedPoints = Math.floor(subtotal * 0.5);
            document.getElementById('potential-points').textContent = earnedPoints;

            if (discount > 0) {
                discountRow.classList.remove('hidden');
                cartDiscountEl.textContent = discount;
                const finalTotal = subtotal - discount;
                totalEl.innerHTML = `<span class="line-through text-gray-500 text-lg ml-2">${subtotal} Ø¬.Ù…</span> <span class="text-green-400">${finalTotal} Ø¬.Ù…</span>`;
                
                if(redeemBtn) {
                    redeemBtn.textContent = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø®ØµÙ…";
                    redeemBtn.classList.remove('bg-yellow-600');
                    redeemBtn.classList.add('bg-red-600');
                }
                if(redeemMsg) {
                    redeemMsg.textContent = `ØªÙ… Ø®ØµÙ… ${discount} Ø¬Ù†ÙŠÙ‡`;
                    redeemMsg.classList.remove('hidden');
                }
            } else {
                discountRow.classList.add('hidden');
                totalEl.textContent = subtotal + ' Ø¬.Ù…';
                
                if(redeemBtn) {
                    redeemBtn.classList.remove('bg-red-600');
                    redeemBtn.classList.add('bg-yellow-600');
                    if(currentUser && currentUser.points >= 50) {
                        redeemBtn.textContent = "Ø®ØµÙ… 25 Ø¬Ù†ÙŠÙ‡";
                    } else {
                        redeemBtn.textContent = "Ø®ØµÙ… (Ù†Ù‚Ø§Ø· ØºÙŠØ± ÙƒØ§ÙÙŠØ©)";
                    }
                }
                if(redeemMsg) redeemMsg.classList.add('hidden');
            }
        }

        window.handleAuthSubmit = async (e) => {
            e.preventDefault();
            const name = document.getElementById('auth-name').value.trim();
            const phone = document.getElementById('auth-phone').value.trim();
            const address = document.getElementById('auth-address').value.trim();

            if(phone.length !== 11) { alert('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† 11 Ø±Ù‚Ù…'); return; }
            if(!name) { alert('Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨'); return; }
            if(!address) { alert('Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…Ø·Ù„ÙˆØ¨'); return; }

            window.showLoading(true);
            window.toggleAuthModal();

            if(phone === ADMIN_PHONE) {
                currentUser = { name: "Admin", phone: ADMIN_PHONE, role: 'admin' };
                localStorage.setItem('dentleen_user_phone', phone);
                updateUserUI();
                window.showLoading(false);
                window.showAdminDashboard();
                return;
            }

            try {
                if(!db) throw new Error("Offline");
                const userRef = doc(db, USERS_COLLECTION, phone);
                const snap = await getDoc(userRef);
                if(snap.exists()) {
                    currentUser = snap.data();
                    // Update address if changed
                    if (currentUser.address !== address) {
                        await updateDoc(userRef, { address: address });
                        currentUser.address = address;
                    }
                    alert(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`);
                } else {
                    const newUser = { name, phone, address, points: 50, role: 'user', joined: new Date().toLocaleDateString('ar-EG') };
                    await setDoc(userRef, newUser);
                    currentUser = newUser;
                    alert('ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø±ØµÙŠØ¯Ùƒ 50 Ù†Ù‚Ø·Ø©.');
                }
                localStorage.setItem('dentleen_user_phone', phone);
                setupUserListener(phone);
                updateUserUI();
            } catch(err) {
                console.error(err);
                currentUser = { name, phone, address, points: 50, role: 'user' }; 
                updateUserUI();
                alert('ØªÙ… Ø§Ù„Ø¯Ø®ÙˆÙ„ (ÙˆØ¶Ø¹ ØºÙŠØ± Ù…ØªØµÙ„)');
            }
            window.showLoading(false);
        };

        window.handleRedeemPoints = () => {
            if(!currentUser || currentUser.points < 50) return;
            isRedeeming = !isRedeeming;
            updateCartUI();
        };

        window.initiateCheckout = () => {
            if(cart.length===0) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');
            
            const name = document.getElementById('checkout-name').value.trim();
            const phone = document.getElementById('checkout-phone').value.trim();
            const address = document.getElementById('checkout-address').value.trim();

            if(!name || phone.length !== 11 || !address) { 
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø§Ø³Ù…ØŒ Ø§Ù„Ù‡Ø§ØªÙ 11 Ø±Ù‚Ù…ØŒ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†).'); 
                return; 
            }

            const list = document.getElementById('confirm-items-list');
            list.innerHTML = '';
            let subtotal = 0;
            cart.forEach(i => {
                subtotal += i.price * i.quantity;
                list.innerHTML += `<div class="flex justify-between text-gray-300 border-b border-gray-700 pb-2 mb-2"><span>${i.name} (x${i.quantity})</span><span>${i.price*i.quantity} Ø¬.Ù…</span></div>`;
            });
            let discount = 0;
            if (isRedeeming && currentUser && currentUser.points >= 50) {
                // UPDATE: 50 points = 25 EGP
                const maxPointsDiscount = Math.floor(currentUser.points / 50) * 25;
                discount = Math.min(maxPointsDiscount, subtotal);
            }
            const total = subtotal - discount;
            const totalEl = document.getElementById('confirm-total-price');
            if(discount > 0) { totalEl.innerHTML = `<span class="line-through text-gray-500 text-sm ml-2">${subtotal}</span> ${total} Ø¬.Ù…`; }
            else { totalEl.textContent = total + " Ø¬.Ù…"; }
            document.getElementById('confirmation-modal').classList.remove('hidden');
        };

        window.closeConfirmModal = () => { document.getElementById('confirmation-modal').classList.add('hidden'); };

        window.confirmOrder = async () => {
            window.closeConfirmModal();
            window.showLoading(true);
            
            const name = document.getElementById('checkout-name').value;
            const phone = document.getElementById('checkout-phone').value;
            const address = document.getElementById('checkout-address').value;

            let subtotal = 0; cart.forEach(i => subtotal += i.price * i.quantity);
            let discount = 0;
            if (isRedeeming && currentUser && currentUser.points >= 50) {
                const maxPointsDiscount = Math.floor(currentUser.points / 50) * 25;
                discount = Math.min(maxPointsDiscount, subtotal);
            }
            const total = subtotal - discount;
            const pointsUsed = (discount/25)*50;
            const earnedPoints = Math.floor(subtotal * 0.5);
            
            // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…Ø­Ø³Ù†
            let msg = `*Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹* ğŸ¦·\n`;
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            msg += `*ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„*\n`;
            msg += `Ø§Ù„Ø§Ø³Ù…: ${name}\n`;
            msg += `Ø§Ù„Ù‡Ø§ØªÙ: ${phone}\n`;
            if(address) msg += `Ø§Ù„Ø¹Ù†ÙˆØ§Ù†: ${address}\n`;
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            msg += `*ğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª*\n`;
            cart.forEach(i => {
                msg += `â–ªï¸ ${i.name}\n   Ø§Ù„Ø¹Ø¯Ø¯: ${i.quantity} | Ø§Ù„Ø³Ø¹Ø±: ${i.price * i.quantity} Ø¬.Ù…\n`; 
            });
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            msg += `*ğŸ’° Ø§Ù„Ø­Ø³Ø§Ø¨*\n`;
            msg += `Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${subtotal} Ø¬.Ù…\n`;
            
            if(discount > 0) {
                msg += `Ø®ØµÙ… Ù†Ù‚Ø§Ø·: -${discount} Ø¬.Ù…\n`;
            }
            
            msg += `*Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ: ${total} Ø¬.Ù…*\n`;
            msg += `â”â”â”â”â”â”â”â”â”â”â”â”\n`;
            msg += `*â­ Ù†Ù‚Ø§Ø· Ø§Ù„ÙˆÙ„Ø§Ø¡*\n`;
            msg += `Ù…Ø³ØªØ­Ù‚Ø©: ${earnedPoints} Ù†Ù‚Ø·Ø©\n`;
            
            if (currentUser && currentUser.role !== 'admin') { 
                let newPointsBalance = currentUser.points - pointsUsed;
                msg += `Ø§Ù„Ø±ØµÙŠØ¯: ${currentUser.points} â¡ï¸ ${newPointsBalance}\n`; 
            }
            
            window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(msg)}`, '_blank');

            if(currentUser && db && currentUser.role !== 'admin') {
                try { 
                    // Deduct points if used
                    if(pointsUsed > 0) {
                        const newPts = currentUser.points - pointsUsed;
                        await updateDoc(doc(db, USERS_COLLECTION, currentUser.phone), { points: newPts });
                    }
                    // Update Address if changed during checkout
                    if(currentUser.address !== address) {
                        await updateDoc(doc(db, USERS_COLLECTION, currentUser.phone), { address: address });
                        currentUser.address = address; // Update local state
                    }
                } catch(e){}
            }
            cart = []; localStorage.removeItem('dentleen_cart');
            isRedeeming = false;
            updateCartUI();
            window.showLoading(false);
        };

        window.logout = () => {
            if(confirm('ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('dentleen_user_phone');
                location.reload();
            }
        };

        window.showAdminDashboard = () => {
            if(!currentUser || currentUser.role !== 'admin') return;
            document.getElementById('main-view').classList.add('hidden');
            document.getElementById('admin-view').classList.remove('hidden');
            document.getElementById('mobile-menu').classList.add('hidden');
            
            if(db) {
                if(adminUnsubscribe) adminUnsubscribe();
                adminUnsubscribe = onSnapshot(collection(db, USERS_COLLECTION), (snap) => {
                    allUsersData = []; 
                    snap.forEach(d => {
                        const u = d.data();
                        if(u.role !== 'admin') {
                            u.docId = d.id; 
                            allUsersData.push(u);
                        }
                    });
                    renderAdminTable(allUsersData);
                });
            } else {
                document.getElementById('total-users-count').textContent = "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„";
            }
        };

        function renderAdminTable(users) {
            const list = document.getElementById('admin-users-list');
            list.innerHTML = '';
            document.getElementById('total-users-count').textContent = users.length + ' Ø¹Ù…ÙŠÙ„';
            users.forEach(u => {
                const tr = document.createElement('tr');
                tr.className = "border-b border-gray-700 hover:bg-gray-700/50 transition";
                tr.innerHTML = `
                    <td>${u.name}</td>
                    <td>${u.phone}</td>
                    <td>${u.address || '-'}</td>
                    <td class="text-yellow-400 font-bold">${u.points}</td>
                    <td>
                        <div class="flex gap-2 justify-end">
                            <input type="number" id="pts-${u.phone}" class="w-16 bg-gray-700 text-white rounded px-1 text-sm" placeholder="0">
                            <button onclick="window.modifyPoints('${u.phone}')" class="bg-blue-600 px-2 rounded text-xs text-white">ØªØ­Ø¯ÙŠØ«</button>
                            <button onclick="window.deleteUser('${u.docId}')" class="bg-red-600 px-2 rounded text-xs text-white" title="Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„"><i class="fas fa-trash"></i></button>
                        </div>
                    </td>
                `;
                list.appendChild(tr);
            });
        }

        window.searchUsers = () => {
            const term = document.getElementById('admin-search').value.toLowerCase();
            const filtered = allUsersData.filter(u => 
                (u.name && u.name.toLowerCase().includes(term)) || 
                (u.phone && u.phone.includes(term))
            );
            renderAdminTable(filtered);
        };

        window.deleteUser = async (docId) => {
            if(confirm('ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ')) {
                if(!db) return;
                try {
                    await deleteDoc(doc(db, USERS_COLLECTION, docId));
                    alert('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­');
                } catch(e) {
                    console.error(e);
                    alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
                }
            }
        };

        window.modifyPoints = async (phone) => {
            if(!db) return;
            const input = document.getElementById(`pts-${phone}`);
            const amount = parseInt(input.value);
            if(isNaN(amount)) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­');
            
            const ref = doc(db, USERS_COLLECTION, phone);
            const s = await getDoc(ref);
            if(s.exists()) {
                const newP = Math.max(0, s.data().points + amount);
                await updateDoc(ref, { points: newP });
                input.value = '';
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ù‚Ø§Ø·');
            }
        };

        let userListener = null;
        function setupUserListener(phone) {
            if(userListener) userListener();
            if(db) {
                userListener = onSnapshot(doc(db, USERS_COLLECTION, phone), (s) => {
                    if(s.exists()) {
                        currentUser.points = s.data().points;
                        currentUser.address = s.data().address || currentUser.address; // Keep address sync
                        updateUserUI();
                    }
                });
            }
        }

        function updateUserUI() {
            const wrapper = document.getElementById('desktop-auth-wrapper');
            const mLogin = document.getElementById('mobile-login-btn');
            const mLogout = document.getElementById('mobile-logout-btn');
            const mAdmin = document.getElementById('mobile-admin-btn');
            const loyalty = document.getElementById('loyalty-section');
            const adminBtn = document.getElementById('admin-link-btn');
            const heroText = document.getElementById('hero-promo-text');
            const statusArea = document.getElementById('user-status-area');
            
            // Populate Checkout Fields
            const checkoutName = document.getElementById('checkout-name');
            const checkoutPhone = document.getElementById('checkout-phone');
            const checkoutAddress = document.getElementById('checkout-address');

            if(currentUser) {
                // LOGGED IN
                heroText.classList.add('opacity-0');
                wrapper.innerHTML = `<button onclick="window.logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-bold text-sm">Ø®Ø±ÙˆØ¬</button>`;
                mLogin.classList.add('hidden');
                mLogout.classList.remove('hidden');
                
                // Pre-fill checkout if user role
                if(currentUser.role !== 'admin') {
                    statusArea.innerHTML = `<div class="points-badge"><i class="fas fa-star text-yellow-600"></i><span>${currentUser.points || 0}</span></div>`;
                    statusArea.classList.remove('hidden');
                    
                    if(checkoutName) checkoutName.value = currentUser.name || '';
                    if(checkoutPhone) checkoutPhone.value = currentUser.phone || '';
                    if(checkoutAddress) checkoutAddress.value = currentUser.address || '';
                } else {
                    statusArea.classList.add('hidden');
                }
                
                if(currentUser.role === 'admin') {
                    adminBtn.classList.remove('hidden');
                    mAdmin.classList.remove('hidden');
                    loyalty.classList.add('hidden');
                } else {
                    loyalty.classList.remove('hidden');
                    document.getElementById('user-points-display').textContent = currentUser.points;
                    const btn = document.getElementById('redeem-btn');
                    if(currentUser.points >= 50) { btn.disabled = false; btn.classList.remove('opacity-50'); } 
                    else { btn.disabled = true; btn.classList.add('opacity-50'); }
                }
            } else {
                // LOGGED OUT
                heroText.classList.remove('opacity-0');
                statusArea.classList.add('hidden');
                wrapper.innerHTML = `<button onclick="window.toggleAuthModal()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg font-bold text-sm">Ø¯Ø®ÙˆÙ„</button>`;
                mLogin.classList.remove('hidden');
                mLogout.classList.add('hidden');
                adminBtn.classList.add('hidden');
                mAdmin.classList.add('hidden');
                loyalty.classList.add('hidden');
                
                // Clear inputs
                if(checkoutName) checkoutName.value = '';
                if(checkoutPhone) checkoutPhone.value = '';
                if(checkoutAddress) checkoutAddress.value = '';
            }
        }

        function populateProductDropdown() {
            const select = document.getElementById('quick-product-select');
            select.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†ØªØ¬...</option>';
            const grp1 = document.createElement('optgroup'); grp1.label = "Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª";
            const grp2 = document.createElement('optgroup'); grp2.label = "Ø§Ù„Ø¹Ø±ÙˆØ¶";
            PRODUCTS_DATA.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.textContent = `${p.name} (${p.price} Ø¬.Ù…)`;
                if(p.type === 'offer') grp2.appendChild(opt); else grp1.appendChild(opt);
            });
            select.appendChild(grp1); select.appendChild(grp2);
        }
        window.addFromDropdown = () => {
            const val = document.getElementById('quick-product-select').value;
            if(val) window.quickAdd(val);
        };

        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => { if(entry.isIntersecting) entry.target.classList.add('is-visible'); });
        });

        const pGrid = document.getElementById('products-grid');
        const oGrid = document.getElementById('offers-grid');
        PRODUCTS_DATA.forEach(p => {
            const h = `<div class="product-card rounded-2xl overflow-hidden cursor-pointer group reveal-on-scroll" onclick="window.openProductPage('${p.id}')">
                <div class="h-48 bg-gray-700/50 flex items-center justify-center p-4"><img src="${p.img}" loading="lazy" class="h-full object-contain" onerror="this.src='https://placehold.co/200?text=Image'"></div>
                <div class="p-4"><h3 class="font-bold text-lg text-white mb-2">${p.name}</h3><div class="flex justify-between items-center"><span class="text-teal-400 font-bold">${p.price} Ø¬.Ù…</span><button class="w-8 h-8 rounded-full bg-gray-700 text-white hover:bg-teal-600" onclick="event.stopPropagation(); window.quickAdd('${p.id}')">+</button></div></div>
            </div>`;
            if(p.type === 'offer') oGrid.innerHTML += h; else pGrid.innerHTML += h;
        });
        
        document.querySelectorAll('.reveal-on-scroll').forEach(el => observer.observe(el));
        populateProductDropdown();

        const savedPhone = localStorage.getItem('dentleen_user_phone');
        if(savedPhone) {
            if(savedPhone === ADMIN_PHONE) {
                currentUser = { name: "Admin", phone: ADMIN_PHONE, role: 'admin' };
                updateUserUI();
            } else if(db) {
                getDoc(doc(db, USERS_COLLECTION, savedPhone)).then(s => {
                    if(s.exists()) { currentUser = s.data(); setupUserListener(savedPhone); updateUserUI(); }
                }).catch(e => console.log("Auto login err", e));
            }
        }
        updateCartUI();
        document.getElementById('auth-form').addEventListener('submit', window.handleAuthSubmit);
        document.getElementById('mobile-menu-btn').addEventListener('click', window.toggleMobileMenu);
        document.getElementById('scrollToTopBtn').addEventListener('click', () => window.scrollTo(0,0));
    </script>
</body>
</html>